{% load static %}
{% load extra_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NYC Restaurant Search</title>
    <link rel="stylesheet" href="{% static 'inspections/style.css' %}">
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".restaurant-header").forEach(header => {
            header.addEventListener("click", () => {
                const content = header.nextElementSibling;
                content.classList.toggle("active");

                // Animate the dropdown smoothly
                if (content.classList.contains("active")) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    content.style.opacity = "1";
                } else {
                    content.style.maxHeight = "0";
                    content.style.opacity = "0";
                }
            });
        });

        // Auto-submit when cuisine changes
        const cuisineSelect = document.querySelector('select[name="cuisine"]');
        if (cuisineSelect) {
            cuisineSelect.addEventListener('change', () => {
                // Ensure the select is inside a form before submitting
                if (cuisineSelect.form) cuisineSelect.form.submit();
            });
        }
        // Auto-submit when borough changes
        const boroughSelect = document.querySelector('select[name="borough"]');
        if (boroughSelect) {
            boroughSelect.addEventListener('change', () => {
                // Ensure the select is inside a form before submitting
                if (boroughSelect.form) boroughSelect.form.submit();
            });
        }
    });
    </script>
</head>
<body class="dark-mode">
    <div class="container">
        <h1>NYC Restaurant Search</h1>

        <!-- Search form -->
        <form method="get">
            <input type="text" name="q" placeholder="Restaurant name..." value="{{ query }}">
            <input type="text" name="z" placeholder="Zipcode" value="{{ zipcode }}">
            <select name="cuisine">
                <option value="">All Cuisines</option>
                {% for c in cuisines %}
                    <option value="{{ c }}" {% if c == selected_cuisine %}selected{% endif %}>
                        {{ c }}
                    </option>
                {% endfor %}
            </select>
            <select name="borough">
                <option value="">All Boroughs</option>
                {% for borough in boroughs %}
                    <option value="{{ borough }}" {% if borough == selected_borough %}selected{% endif %}>
                        {{ borough }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit">Search</button>
        </form>

        <!-- Conditional Results -->
        {% comment %} Show results when any filter/search input is present {% endcomment %}
        {% if query or selected_cuisine or selected_borough or zipcode %}
            <h2>Results ({{ restaurants|length }})</h2>

            {% if restaurants %}
                <ul class="restaurant-list">
                    {% for r in restaurants %}
                        <li class="restaurant-item">
                            <div class="restaurant-header">
                                <div class="restaurant-name-address">
                                    <strong>{{ r.info.DBA }}</strong>
                                    <span class="address">{{ r.info.BUILDING }} {{ r.info.STREET }}, {{ r.info.BORO }}{% if r.info.ZIPCODE %} {{ r.info.ZIPCODE|floatformat:0 }}{% endif %}</span>
                                </div>
                                <span class="details">
                                    Cuisine: {{ r.info.CUISINE_DESCRIPTION }} |
                                    Grade: {{ r.info.GRADE }} |
                                    Score: {{ r.info.SCORE }}
                                </span>
                            </div>

                            <div class="restaurant-content">
                                {% for insp in r.citations %}
                                    <div class="inspection-entry">
                                        <p><b>Date:</b> {{ insp.INSPECTION_DATE }}</p>
                                        <p><b>Action:</b> {{ insp.ACTION }}</p>
                                        <p><b>Violation:</b> {{ insp.VIOLATION_DESCRIPTION }}</p>
                                        <p><b>Critical:</b> {{ insp.CRITICAL_FLAG }}</p>
                                        <hr>
                                    </div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>
                    No results found
                    {% if query %} for “{{ query }}”{% endif %}
                    {% if selected_cuisine %}{% if query %}, {% else %} for {% endif %}cuisine “{{ selected_cuisine }}”{% endif %}
                    {% if selected_borough %}{% if query or selected_cuisine %}, {% else %} for {% endif %}borough “{{ selected_borough }}”{% endif %}
                    {% if zipcode %}{% if query or selected_cuisine or selected_borough %}, {% else %} for {% endif %}zipcode “{{ zipcode }}”{% endif %}.
                </p>
            {% endif %}
        {% else %}
            <h2>Enter a restaurant name, select a cuisine/borough, or type a zipcode to begin your search</h2>
        {% endif %}
    </div>
</body>
</html>